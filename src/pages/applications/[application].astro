---
import Layout from '@/layouts/Layout.astro'
import { routes } from '@/consts/routes.ts'
import type { Route } from '@/types/routes.ts'
import applications from '@/consts/applications.ts'
import type { Application } from '@/types/applications'
import { Send, CircleAlert } from 'lucide-astro'

const { application: slug } = Astro.params

export function getStaticPaths() {
  return (routes.applications.children as Route[]).map(({ path }: Route) => ({
    params: { application: path.replace('/applications/', '') }
  }))
}

const application = applications.find(
  a => a.id.toLowerCase() === slug.toLowerCase()
) as Application
---

<Layout title={`Postulaciones a ${application.name} - TS Community`}>
  <div class="w-full h-full" style={`background: ${application.color}`}>
    <div class="max-w-4xl mx-auto py-12 px-6 text-white">

    <div transition:name={`application-card-${application.id}`} class="rounded-xl overflow-hidden border border-white/10 mb-12">
      <div class="p-8 bg-darker">
        <div class="flex items-center gap-4">
          <img
            src={application.icon.url} 
            alt={application.icon.alt} 
            class="w-16 h-16 object-contain rounded-lg"
          />
          <div>
            <h1 class="text-4xl font-semibold">{`Postulaciones a ${application.name}`}</h1>
            <p class="opacity-70 mt-1">{application.description}</p>
          </div>
        </div>
      </div>

      <img src={application.banner.url} alt={application.banner.alt} class="w-full h-48 object-cover" />
    </div>

      <form id="appForm" class="space-y-12">
        {application.sections.map((section, sIndex) => (
          <section class="bg-darker border border-white/10 p-6 rounded-xl">
            <h2 class="text-xl font-semibold mb-6 flex items-center gap-3">
              <span class="w-8 h-8 bg-dark border border-white/10 rounded-lg flex items-center justify-center">
                {sIndex + 1}
              </span>
              {section.name}
            </h2>

            <div class="space-y-6">
              {section.questions.map((q, qIndex) => {
                const fieldId = `field-${sIndex}-${qIndex}`
                return (
                  <div class="flex flex-col gap-2 bg-dark border border-white/10 p-4 rounded-lg">
                    <label for={fieldId} class="text-large flex items-center gap-1">
                      {q.label}
                      {q.required && <span class="pl-1 text-red-500">*</span>}
                    </label>

                    {q.aside && (
                      <p class="text-md italic opacity-70 font-md" set:html={q.aside}></p>
                    )}

                    {q.type === "short" && (
                      <input
                        id={fieldId}
                        name={q.label}
                        type="text"
                        class="bg-darker border border-white/10 px-3 py-2 rounded-lg"
                        placeholder="Tu respuesta"
                        data-required={q.required}
                      />
                    )}

                    {q.type === "long" && (
                      <textarea
                        id={fieldId}
                        name={q.label}
                        class="bg-darker border border-white/10 px-3 py-2 resize-none rounded-lg min-h-[120px] resize-y"
                        placeholder="Tu respuesta"
                        data-required={q.required}
                      ></textarea>
                    )}

                    {q.type === "select" && (
                      <select
                        id={fieldId}
                        name={q.label}
                        class="bg-darker border border-white/10 px-3 py-2 rounded-lg"
                        data-required={q.required}
                      >
                        <option value="">Selecciona una opción</option>
                        {q.options?.map((opt) => <option value={opt}>{opt}</option>)}
                      </select>
                    )}
                  </div>
                )
              })}
            </div>
            {sIndex === application.sections.length - 1 && (
            <div class="mt-8 flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
              <a
                href="https://docs.google.com/forms/d/e/1FAIpQLSeyoj46uMzH7qliXpifjIYQbdLoJKyrbGzR38eyZhOHk-Frrw/viewform"
                target="_blank"
                rel="noopener noreferrer"
                class="text-sm opacity-60 hover:opacity-100 transition-opacity underline sm:self-start sm:mt-auto"
              >
                O completa el formulario en Google Forms
              </a>

              <button
                type="button"
                id="openModalBtn"
                class="px-6 py-3 rounded-lg font-semibold text-lg bg-blue hover:bg-dark-blue hover:scale-105 transition-all duration-300 flex items-center justify-center gap-2 whitespace-nowrap"
              >
                <Send class="w-5 h-5" />
                Enviar Postulación
              </button>
            </div>
            )}
          </section>
        ))}
      </form>

      <!-- MODAL -->
      <div id="modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-dark w-full max-w-md p-6 rounded-xl border border-white/10 shadow-2xl">
          <h3 class="text-xl font-semibold mb-4">Enviar aplicación</h3>
          <p class="text-gray mb-6">
            Tus datos están listos para ser enviados. Aquí puedes llamar a una API, webhook, base de datos o lo que necesites.
          </p>

          <div class="flex justify-end gap-3">
            <button
              id="closeModal"
              class="px-4 py-2 rounded-lg border border-white/20 text-white"
            >
              Cancelar
            </button>

            <button
              id="confirmSubmit"
              class="px-4 py-2 rounded-lg text-black"
              style="background: linear-gradient(120deg, var(--color-light-blue), var(--color-pink));"
            >
              Confirmar envío
            </button>
          </div>
        </div>
      </div>

      <script is:inline>
        const modal = document.getElementById("modal")
        const openBtn = document.getElementById("openModalBtn")
        const closeBtn = document.getElementById("closeModal")
        const confirmBtn = document.getElementById("confirmSubmit")
        const form = document.getElementById("appForm")

        if (form) {
          const textareas = form.querySelectorAll('textarea')
          textareas.forEach((textarea) => {
            const minHeight = parseInt(getComputedStyle(textarea).minHeight)
            textarea.addEventListener('input', () => {
              textarea.style.height = 'auto'
              textarea.style.height = Math.max(textarea.scrollHeight, minHeight) + 'px'
            })
          })

          const fields = form.querySelectorAll('input, textarea, select')
          fields.forEach((field) => {
            const required = field.dataset.required === 'true'
            if (!required) return

            const parent = field.parentElement
            if (!parent) return

            let errorMsg = parent.querySelector('.error-msg')
            if (!errorMsg) {
              errorMsg = document.createElement('div')
              errorMsg.className = 'error-msg flex items-center gap-1 text-sm mt-1 opacity-0 transition-opacity duration-200 text-red'
              errorMsg.innerHTML = `<span class="w-4 h-4"><CircleAlert class="w-4 h-4" /></span> Este campo es obligatorio.`
              parent.appendChild(errorMsg)
            }

            field.addEventListener('blur', () => {
              if (!field.value.trim()) {
                field.classList.add('border-red')
                errorMsg.style.opacity = '1'
              } else {
                field.classList.remove('border-red')
                errorMsg.style.opacity = '0'
              }
            })
          })
        }

        if (openBtn && modal) {
          openBtn.addEventListener('click', () => {
            modal.classList.remove('hidden')
            modal.classList.add('flex')
          })
        }

        if (closeBtn && modal) {
          closeBtn.addEventListener('click', () => {
            modal.classList.add('hidden')
            modal.classList.remove('flex')
          })
        }
      </script>
    </div>
  </div>
</Layout>